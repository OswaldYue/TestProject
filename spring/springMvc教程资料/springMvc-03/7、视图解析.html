<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3287"/>
<h1>7、视图解析</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/6/21 9:14</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/6/21 14:08</i></td></tr>
<tr><td><b>作者：</b></td><td><i>雷丰阳</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div>SpringMVC视图解析；</div><div>1、方法执行后的返回值会作为页面地址参考，转发或者重定向到页面</div><div>2、视图解析器可能会进行页面地址的拼串；</div><div><br/></div><div><hr/></div><div>1、任何方法的返回值，最终都会被包装成ModelAndView对象</div><div><img src="7、视图解析_files/Image.png" type="image/png" style="height: auto;"/></div><div>2、<font face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae">processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);来到页面的方法</span></font></div><div><font face="Consolas">视图渲染流程：将域中的数据在页面展示；页面就是用来渲染模型数据的；</font></div><div><span style="font-family: Consolas;">3、调用</span><font face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae">render(mv, request, response);渲染页面</span></font></div><div><span style="font-family: Consolas;"><span style="background-color: rgb(198, 219, 174);">4、View与ViewResolver；</span></span></div><div><span style="font-family: Consolas;"><span style="background-color: rgb(198, 219, 174);">     ViewResolver的作用是根据视图名（方法的返回值）得到View对象；</span></span></div><div><img src="7、视图解析_files/Image [1].png" type="image/png" style="height: auto;"/></div><div>5、怎么能根据方法的返回值（视图名）得到View对象？</div><div>     </div><div align="left" style="min-height: 18pt;"><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>protected View resolveViewName(String viewName, Map&lt;String, Object&gt; model, Locale locale,</div><div>            HttpServletRequest request) throws Exception {</div><div><br/></div><div>          //遍历所有的ViewResolver；</div><div>        <span style="color: rgb(255, 0, 0);">for (ViewResolver viewResolver : this.viewResolvers) {</span></div><div><span style="color: rgb(255, 0, 0);">          //viewResolver视图解析器根据方法的返回值，得到一个View对象；</span></div><div>            <span style="color: rgb(227, 0, 0);">View view = viewResolver.resolveViewName(viewName, locale);</span></div><div>            if (view != null) {</div><div>                return view;</div><div>            }</div><div>        }</div><div>        return null;</div><div>    }</div></div><div><span style="color: rgb(227, 0, 0);">resolveViewName实现</span></div></div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@Override</div><div>    public View resolveViewName(String viewName, Locale locale) throws Exception {</div><div>        if (!isCache()) {</div><div>            return createView(viewName, locale);</div><div>        }</div><div>        else {</div><div>            Object cacheKey = getCacheKey(viewName, locale);</div><div>            View view = this.viewAccessCache.get(cacheKey);</div><div>            if (view == null) {</div><div>                synchronized (this.viewCreationCache) {</div><div>                    view = this.viewCreationCache.get(cacheKey);</div><div>                    if (view == null) {</div><div>                        // Ask the subclass to create the View object.</div><div>                         //根据方法的返回值创建出视图View对象；</div><div>                       <b><span style="color: rgb(227, 0, 0);"> view</span> = createView(<span style="color: rgb(227, 0, 0);">viewName</span>, locale);</b></div><div>                        if (view == null &amp;&amp; this.cacheUnresolved) {</div><div>                            view = UNRESOLVED_VIEW;</div><div>                        }</div><div>                        if (view != null) {</div><div>                            this.viewAccessCache.put(cacheKey, view);</div><div>                            this.viewCreationCache.put(cacheKey, view);</div><div>                            if (logger.isTraceEnabled()) {</div><div>                                logger.trace(&quot;Cached view [&quot; + cacheKey + &quot;]&quot;);</div><div>                            }</div><div>                        }</div><div>                    }</div><div>                }</div><div>            }</div><div>            return (view != UNRESOLVED_VIEW ? view : null);</div><div>        }</div><div>    }</div></div><div>创建View对象；</div><div><img src="7、视图解析_files/Image [2].png" type="image/png" style="height: auto;"/></div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@Override</div><div>    protected <span style="color: rgb(227, 0, 0);"><b>View</b></span> createView(String viewName, Locale locale) throws Exception {</div><div>        // If this resolver is not supposed to handle the given view,</div><div>        // return null to pass on to the next resolver in the chain.</div><div>        if (!canHandle(viewName, locale)) {</div><div>            return null;</div><div>        }</div><div>        // Check for special &quot;redirect:&quot; prefix.</div><div>       <span style="color: rgb(227, 0, 0);"> if (viewName.startsWith(REDIRECT_URL_PREFIX))</span> {</div><div>            String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length());</div><div>            <b><span style="color: rgb(255, 0, 0);">RedirectView view = new RedirectView</span></b>(redirectUrl, isRedirectContextRelative(), isRedirectHttp10Compatible());</div><div>            return applyLifecycleMethods(viewName, view);</div><div>        }</div><div>        // Check for special &quot;forward:&quot; prefix.</div><div>        <span style="color: rgb(227, 0, 0);"><b>if (viewName.startsWith(FORWARD_URL_PREFIX)) {</b></span></div><div>            String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length());</div><div>            return <b><span style="color: rgb(227, 0, 0);">new InternalResourceView(forwardUrl);</span></b></div><div>        }</div><div>        // Else fall back to superclass implementation: calling loadView.</div><div>        //如果没有前缀就使用父类默认创建一个View；</div><div>        <b><span style="color: rgb(227, 0, 0);">return super.createView(viewName, locale);</span></b></div><div>    }</div></div><div><img src="7、视图解析_files/Image [3].png" type="image/png" style="height: auto;"/></div><div><br/></div></div></div><div><img src="7、视图解析_files/Image [4].png" type="image/png" style="height: auto;"/></div><div>返回View对象；</div><div>1、视图解析器得到View对象的流程就是，所有配置的视图解析器都来尝试根据视图名（返回值）得到View（视图）对象；如果能得到就返回，得不到就换下一个视图解析器；</div><div>2、调用View对象的render方法；</div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@Override</div><div>    public void render(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response) throws Exception {</div><div>        if (logger.isTraceEnabled()) {</div><div>            logger.trace(&quot;Rendering view with name '&quot; + this.beanName + &quot;' with model &quot; + model +</div><div>                &quot; and static attributes &quot; + this.staticAttributes);</div><div>        }</div><div><br/></div><div>        Map&lt;String, Object&gt; mergedModel = createMergedOutputModel(model, request, response);</div><div><br/></div><div>        prepareResponse(request, response);</div><div>        <b><span style="color: rgb(227, 0, 0);">//渲染要给页面输出的所有数据</span></b></div><div>        <span style="color: rgb(227, 0, 0);">renderMergedOutputModel(mergedModel, request, response);</span></div><div>    }</div></div><div><br/></div></div><div align="left" style="min-height: 18pt;"><div>InternalResourceView有这个方法renderMergedOutputModel；</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@Override</div><div>    protected void renderMergedOutputModel(</div><div>            Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response) throws Exception {</div><div><br/></div><div>        // Determine which request handle to expose to the RequestDispatcher.</div><div>        HttpServletRequest requestToExpose = getRequestToExpose(request);</div><div><br/></div><div>        // Expose the model object as request attributes.</div><div>        //将模型中的数据放在请求域中</div><div>        <b><span style="color: rgb(227, 0, 0);">exposeModel</span>As<span style="color: rgb(227, 0, 0);">RequestAttributes</span>(model, requestToExpose);</b></div><div><br/></div><div>        // Expose helpers as request attributes, if any.</div><div>        exposeHelpers(requestToExpose);</div><div><br/></div><div>        // Determine the path for the request dispatcher.</div><div>        String dispatcherPath = prepareForRendering(requestToExpose, response);</div><div><br/></div><div>        // Obtain a RequestDispatcher for the target resource (typically a JSP).</div><div>        RequestDispatcher rd = getRequestDispatcher(requestToExpose, dispatcherPath);</div><div>        if (rd == null) {</div><div>            throw new ServletException(&quot;Could not get RequestDispatcher for [&quot; + getUrl() +</div><div>                    &quot;]: Check that the corresponding file exists within your web application archive!&quot;);</div><div>        }</div><div><br/></div><div>        // If already included or response already committed, perform include, else forward.</div><div>        if (useInclude(requestToExpose, response)) {</div><div>            response.setContentType(getContentType());</div><div>            if (logger.isDebugEnabled()) {</div><div>                logger.debug(&quot;Including resource [&quot; + getUrl() + &quot;] in InternalResourceView '&quot; + getBeanName() + &quot;'&quot;);</div><div>            }</div><div>            rd.include(requestToExpose, response);</div><div>        }</div><div><br/></div><div>        else {</div><div>            // Note: The forwarded resource is supposed to determine the content type itself.</div><div>            if (logger.isDebugEnabled()) {</div><div>                logger.debug(&quot;Forwarding to resource [&quot; + getUrl() + &quot;] in InternalResourceView '&quot; + getBeanName() + &quot;'&quot;);</div><div>            }</div><div>            rd.forward(requestToExpose, response);</div><div>        }</div><div>    }</div></div><div><br/></div><div><br/></div><div align="left" style="min-height: 18pt;"><div>将模型中的所有数据取出来全放在request域中</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>protected void exposeModelAsRequestAttributes(Map&lt;String, Object&gt; model, HttpServletRequest request) throws Exception {</div><div>       <span style="color: rgb(227, 0, 0);"> for (Map.Entry&lt;String, Object&gt; entry : model.entrySet()) {</span></div><div>            String <span style="color: rgb(227, 0, 0);">modelName</span> = entry.getKey();</div><div>            Object <span style="color: rgb(227, 0, 0);">modelValue</span> = entry.getValue();</div><div>            if (modelValue != null) {</div><div>                <span style="color: rgb(227, 0, 0);">request.setAttribute(modelName, modelValue);</span></div><div>                if (logger.isDebugEnabled()) {</div><div>                    logger.debug(&quot;Added model object '&quot; + modelName + &quot;' of type [&quot; + modelValue.getClass().getName() +</div><div>                            &quot;] to request in view with name '&quot; + getBeanName() + &quot;'&quot;);</div><div>                }</div><div>            }</div><div>            else {</div><div>                request.removeAttribute(modelName);</div><div>                if (logger.isDebugEnabled()) {</div><div>                    logger.debug(&quot;Removed model object '&quot; + modelName +</div><div>                            &quot;' from request in view with name '&quot; + getBeanName() + &quot;'&quot;);</div><div>                }</div><div>            }</div><div>        }</div><div>    }</div></div><div><br/></div></div></div><div>一句话：</div><div>视图解析器只是为了得到视图对象；视图对象才能真正的<span style="color: rgb(227, 0, 0);">转发（将模型数据全部放在请求域中）或者重定向到页面</span></div><div>视图对象才能真正的<span style="color: rgb(227, 0, 0);">渲染视图；</span></div><div>ViewResolver;</div><div><img src="7、视图解析_files/Image [5].png" type="image/png" style="height: auto;"/></div><div>View:</div><div><img src="7、视图解析_files/Image [6].png" type="image/png" style="height: auto;"/></div><div><br/></div><div><hr/></div><div>1、导包导入了jstl的时候会自动创建为一个jstlView；可以快速方便的支持国际化功能；</div><div>2、可以支持快速国际化；</div><div>     1）、javaWeb国际化步骤；</div><div>               1）、得得到一个Locale对象；</div><div>               2）、使用ResourceBundle绑定国际化资源文件；</div><div>               3）、使用ResourceBundle.getString(&quot;key&quot;)；获取到国际化配置文件中的值；</div><div>               4）、web页面的国际化，fmt标签库来做；</div><div>                         &lt;fmt:setLocale&gt;</div><div>                         &lt;fmt:setBundle &gt;   </div><div>                         &lt;fmt:message&gt;</div><div>     2）、有了JstlView以后；</div><div>               1）、让Spring管理国际化资源就行</div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    &lt;!--让SpringMVC管理国际化资源文件；配置一个资源文件管理器  --&gt;</div><div>    &lt;bean id=&quot;messageSource&quot; class=&quot;org.springframework.context.support.ResourceBundleMessageSource&quot;&gt;</div><div>        &lt;!--  basename指定基础名--&gt;</div><div>        &lt;property name=&quot;basename&quot; value=&quot;i18n&quot;&gt;&lt;/property&gt;</div><div>    &lt;/bean&gt;</div></div><div><br/></div></div><div>               2）、直接去页面使用&lt;fmt:message&gt;；</div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>&lt;fmt:message key=&quot;welcomeinfo&quot;/&gt;</div><div>&lt;/h1&gt;</div><div>&lt;form action=&quot;&quot;&gt;</div><div>    &lt;fmt:message key=&quot;username&quot;/&gt;:&lt;input /&gt;&lt;br/&gt;</div><div>    &lt;fmt:message key=&quot;password&quot;/&gt;:&lt;input /&gt;&lt;br/&gt;</div><div>    &lt;input type=&quot;submit&quot; value='&lt;fmt:message key=&quot;loginBtn&quot;/&gt;'/&gt;</div><div>&lt;/form&gt;</div></div><div>一定要过SpringMVC的视图解析流程，人家会创建一个jstlView帮你快速国际化；</div><div>也不能写forward:（</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">if (viewName.startsWith(FORWARD_URL_PREFIX)) {</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">            String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length());</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">            return new InternalResourceView(forwardUrl);</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">        }</span></span></span></div></div><div>）</div><div><hr/></div><div>扩展：加深视图解析器和视图对象；</div><div>          视图解析器根据方法的返回值得到视图对象；</div><div>          多个视图解析器都会尝试能否得到视图对象；</div><div>          视图对象不同就可以具有不同功能；</div><div><br/></div><div> <span style="color: rgb(255, 0, 0);">for (ViewResolver viewResolver : this.viewResolvers) {</span></div><div><span style="color: rgb(255, 0, 0);">          //viewResolver视图解析器根据方法的返回值，得到一个View对象；</span></div><div>            <span style="color: rgb(227, 0, 0);">View view = viewResolver.resolveViewName(viewName, locale);</span></div><div>            if (view != null) {</div><div>                return view;</div><div>            }</div><div>        }</div><div><br/></div><div><hr/></div><div>1、让我们的视图解析器工作；</div><div>2、得到我们的视图对象</div><div>3、我们的视图对象自定义渲染逻辑</div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>response.getWriter().write(&quot;哈哈&lt;h1&gt;即将展现精彩内容&lt;/h1&gt;&quot;);</div></div><div><img src="7、视图解析_files/Image [7].png" type="image/png"/></div><div><br/></div><div><br/></div><div>1、自定义视图和视图解析器的步骤；</div><div>     1）、编写自定义的视图解析器，和视图实现类</div><div>     2）、视图解析器必须放在ioc容器中，让其工作，能创建出我们的自定义视图对象；</div><div><br/></div><div><hr/></div><div><br/></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 